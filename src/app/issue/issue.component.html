<div class="issue-page">
  <div class="issue-card">
    <div class="issue-header">
      <h2 class="issue-title">Issue Part to Vendor</h2>
    </div>

    <!-- ===== Loading header (optional) ===== -->
    <div class="instruction-card" *ngIf="isLoadingHeader">
      <div class="instruction-title">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading header...</span>
      </div>
    </div>

    <!-- ===== HEADER SUMMARY (มี header แล้ว และไม่ได้ edit) ===== -->
    <div
      class="header-summary"
      *ngIf="
        header &&
        !showHeaderForm &&
        !isLoadingVendor &&
        !isLoadingControlLot
      "
    >
      <div class="header-summary-title">
        <i class="fas fa-file-signature"></i>
        <span>Header Saved</span>
      </div>

      <div class="header-summary-grid">
        <div class="hs-item">
          <div class="hs-k">วันที่ส่งงาน</div>
          <div class="hs-v">{{ isoToYmd(header.sentDateByUser) }}</div>
        </div>

        <div class="hs-item">
          <div class="hs-k">Shift</div>
          <div class="hs-v">{{ header.shift }}</div>
        </div>

        <div class="hs-item span-2">
          <div class="hs-k">Vendor</div>
          <div class="hs-v">{{ vendorName(header.venderId) }}</div>
        </div>

        <div class="hs-item">
          <div class="hs-k">Item No.</div>
          <div class="hs-v">{{ header.itemNo }}</div>
        </div>

        <div class="hs-item">
          <div class="hs-k">Item Name</div>
          <div class="hs-v">{{ header.itemName }}</div>
        </div>

        <div class="hs-item">
          <div class="hs-k">Control Lot</div>
          <div class="hs-v">{{ controlLotName(header.controlLotId) }}</div>
        </div>

        <div class="hs-item">
          <div class="hs-k">Total QTY BOX</div>
          <div class="hs-v">{{ header.qtyBox }}</div>
        </div>
      </div>


      <div class="header-summary-actions gap-2">
        <button type="button" class="btn-delete-header" (click)="onDeleteHeaderTemp()">
          <i class="fas fa-trash-alt"></i>
          Delete Header
        </button>
        <button type="button" class="btn-soft" (click)="onClickEditHeader()">
          <i class="fas fa-pen me-1"></i>
          Edit Header
        </button>
      </div>
    </div>

    <!-- ===== HEADER FORM (ยังไม่มี header หรือกำลัง edit) ===== -->
    <form class="issue-form" autocomplete="off" *ngIf="showHeaderForm">
      <div class="form-grid">
        <div class="form-field">
          <label class="form-label">วันที่ส่งงาน</label>
          <div class="input-wrap">
            <input
              class="form-control"
              type="datetime-local"
              [(ngModel)]="form.sentDateByUser"
              name="sentDateByUser"
              [disabled]="isSavingHeader"
            />
            <span class="input-icon"><i class="far fa-calendar"></i></span>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Shift</label>
          <div class="input-wrap">
            <select
              class="form-control"
              [(ngModel)]="form.shift"
              name="shift"
              [disabled]="isSavingHeader"
            >
              <option value="" disabled>เลือกกะการทำงาน</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>

        <div class="form-field span-2">
          <label class="form-label">Select Vendor</label>
          <div class="input-wrap">
            <select
              class="form-control"
              [(ngModel)]="form.venderId"
              name="venderId"
              [disabled]="isLoadingVendor || isSavingHeader"
            >
              <option [ngValue]="null" disabled>
                {{ isLoadingVendor ? 'กำลังโหลด Vendor...' : 'เลือก Vendor' }}
              </option>
              <option *ngFor="let v of vendors" [ngValue]="v.id">
                {{ v.name }}
              </option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Select Item No.</label>
          <div class="input-wrap">
            <select
              class="form-control"
              [ngModel]="form.itemNo"
              (ngModelChange)="onSelectItemNo($event)"
              name="itemNo"
              [disabled]="isLoadingItem || isSavingHeader"
            >
              <option value="" disabled>
                {{ isLoadingItem ? 'กำลังโหลด Item...' : 'เลือก Item No.' }}
              </option>

              <option *ngFor="let it of items" [value]="it.itemNo">
                {{ it.itemNo }}
              </option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Auto Item Name</label>
          <div class="input-wrap">
            <input
              class="form-control"
              type="text"
              [(ngModel)]="form.itemName"
              name="itemName"
              readonly
            />
            <span class="input-icon"><i class="fas fa-tag"></i></span>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Control Lot</label>
          <div class="input-wrap">
            <select
              class="form-control"
              [(ngModel)]="form.controlLotId"
              name="controlLotId"
              [disabled]="isLoadingControlLot || isSavingHeader"
            >
              <option [ngValue]="null" disabled>
                {{
                  isLoadingControlLot
                    ? 'กำลังโหลด Control Lot...'
                    : 'เลือก Control Lot'
                }}
              </option>
              <option *ngFor="let c of controlLots" [ngValue]="c.id">
                {{ c.name }}
              </option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>

        <div class="form-field">
          <label class="form-label">Total QTY BOX</label>
          <input
            class="form-control"
            type="number"
            [(ngModel)]="form.qtyBox"
            name="qtyBox"
            placeholder="Max 42 Box/ครั้ง"
            [disabled]="isSavingHeader"
          />
        </div>
      </div>

      <button
        type="button"
        class="btn-save"
        (click)="onSaveHeader()"
        [disabled]="isSavingHeader"
      >
        {{ isSavingHeader ? 'Saving...' : 'Save' }}
      </button>

      <button
        type="button"
        class="btn-cancel"
        *ngIf="header"
        (click)="onCancelEditHeader()"
        [disabled]="isSavingHeader"
      >
        Cancel Edit
      </button>
    </form>

    <!-- Instruction box -->
    <div class="instruction-card">
      <div class="instruction-title">
        <i class="fas fa-qrcode"></i>
        <span>Scan QR Code Instructions</span>
      </div>

      <ul class="instruction-list">
        <li>หลังจาก scan QR ให้ทำเส้นเดียวกันหัวกดดี scan จนครบทุกใบที่ scan</li>
        <li>ถ้าต้องมีการยกเลิกการ Scan QR ที่แสดงกล่องชัดเจน จะไม่สามารถ Scan QR ได้</li>
        <li>หาก Scan QR ซ้ำ ให้มี Pop up เตือนแจ้ง เพื่อให้เห็นกะทำงานก่อน Scan ซ้ำ</li>
        <li>
          ไม่สามารถ Scan QR แสดงลงทำการรับทั้งก่อนออนไลน์ได้ ทั้ง Send และ Receive จะทำได้ต่อเมื่อมีการ
          Receive complete แล้วเท่านั้น
        </li>
      </ul>
    </div>

      <!-- ===== Temp Stack (รอรับข้อมูล / ยังไม่ Confirm) ===== -->
      <div class="box-full-wrap" *ngIf="isBoxFull">
        <div class="box-full-banner">
          <i class="fas fa-check-circle"></i>
          <span>Box ครบแล้ว</span>
        </div>
      </div>
      
      
      
      
    <div class="stack-card" *ngIf="!isBoxFull" >
      <div class="stack-header">
        <div class="stack-title">
          <i class="fas fa-qrcode me-2"></i>
          <span>Scan QR Form WOS</span>
        </div>
      </div>

      <div class="stack-grid">
        <div class="stack-item">
          <div class="stack-k">Item No.</div>
          <input
            #scanItemNo
            class="form-control"
            type="text"
            placeholder=""
            [(ngModel)]="boxForm.itemNo"
            name="box_itemNo"
            [disabled]="!header || isEditingHeader || isSavingBox"
            (keydown.enter)="onScanEnter('itemNo', $event)"
          />
        </div>
      
        <div class="stack-item">
          <div class="stack-k">Item Name</div>
          <input
            #scanItemName
            class="form-control"
            type="text"
            placeholder=""
            [(ngModel)]="boxForm.itemName"
            name="box_itemName"
            [disabled]="!header || isEditingHeader || isSavingBox"
            (keydown.enter)="onScanEnter('itemName', $event)"
          />
        </div>
      
        <div class="stack-item">
          <div class="stack-k">Item WOS No.</div>
          <input
            #scanWosNo
            class="form-control"
            type="text"
            placeholder=""
            [(ngModel)]="boxForm.wosNo"
            name="box_wosNo"
            [disabled]="!header || isEditingHeader || isSavingBox"
            (keydown.enter)="onScanEnter('wosNo', $event)"
          />
        </div>
      
        <div class="stack-item">
          <div class="stack-k">DWG</div>
          <input
            #scanDwg
            class="form-control"
            type="text"
            placeholder=""
            [(ngModel)]="boxForm.dwg"
            name="box_dwg"
            [disabled]="!header || isEditingHeader || isSavingBox"
            (keydown.enter)="onScanEnter('dwg', $event)"
          />
        </div>
      
        <div class="stack-item">
          <div class="stack-k">Die No.</div>
          <input
            #scanDieNo
            class="form-control"
            type="text"
            placeholder=""
            [(ngModel)]="boxForm.dieNo"
            name="box_dieNo"
            [disabled]="!header || isEditingHeader || isSavingBox"
            (keydown.enter)="onScanEnter('dieNo', $event)"
          />
        </div>
      
        <div class="stack-item">
          <div class="stack-k">Lot No.</div>
          <input
            #scanLotNo
            class="form-control"
            type="text"
            placeholder=""
            [(ngModel)]="boxForm.lotNo"
            name="box_lotNo"
            [disabled]="!header || isEditingHeader || isSavingBox"
            (keydown.enter)="onScanEnter('lotNo', $event)"
          />
        </div>
      
        <div class="stack-item">
          <div class="stack-k">Quantity</div>
          <input
            #scanQty
            class="form-control"
            type="number"
            placeholder=""
            [(ngModel)]="boxForm.qty"
            name="box_qty"
            [disabled]="!header || isEditingHeader || isSavingBox"
            (keydown.enter)="onScanEnter('qty', $event)"
            (keydown.tab)="loopFocusToFirst($event)"
          />
        </div>
      </div>
      

      <div class="stack-note">
        * Temp Stack = รายการที่ scan เข้าแล้ว แต่ยังไม่กด Confirm Lot
      </div>

      <div class="stack-actions">
        <!-- <button
          type="button"
          class="btn-soft"
          (click)="onConfirmLot()"
          [disabled]="!header || isEditingHeader || isSavingBox"
        >
          <i class="fas fa-check-circle me-1"></i>
          Confirm Lot
        </button> -->

        <button
          type="button"
          class="btn-soft danger"
          (click)="onClearBoxForm()"
          [disabled]="isSavingBox"
        >
          <i class="fas fa-trash-alt me-1"></i>
          Clear
        </button>
      </div>

      
    </div>


    <!-- ===== Saved List (บันทึกแล้ว / IQC) ===== -->
    <div class="saved-card">
      <div class="saved-header">
        <div class="saved-title">
          <i class="fas fa-clipboard-check"></i>
          <span>รายการที่สแกนแล้ว</span>
            <span
            class="ms-2 badge rounded-pill bg-secondary"
            *ngIf="header && !isEditingHeader"
            title="จำนวนรายการที่บันทึกแล้ว"
          >
            BOX: {{ savedRows.length || 0 }}

          </span>
        </div>

        <button
        type="button"
        class="btn-soft danger"
        (click)="onDeleteAllBoxScan()"
        [disabled]="!header || isEditingHeader || isLoadingSaved || isClearingAll || (savedRows.length === 0)"
      >
      <i class="fas fa-trash-alt me-1"></i>
        Clear
      </button>
      

        <button
          type="button"
          class="btn-issue"
          (click)="onClickIssue()"
          [disabled]="
            isIssuing ||
            !header ||
            isEditingHeader ||
            isLoadingSaved ||
            (savedRows.length < header!.qtyBox) || 
            (savedRows.length > header!.qtyBox)
          "
        >
          <i class="fas fa-truck"></i>
          {{ isIssuing ? 'Issuing...' : 'Issue' }}
        </button>

      </div>

      <div class="table-wrap">
        <table class="saved-table">
          <thead>
            <tr>
              <th>Item No.</th>
              <th>Item Name</th>
              <th>WOS NO</th>
              <th>DWG</th>
              <th>DIE NO</th>
              <th>LOT NO</th>
              <th class="text-end">QTY</th>
              <th class="text-center">Edit</th>
              <th class="text-center">Delete</th>
            </tr>
          </thead>
          <tbody>
            <!-- Loading -->
            <tr *ngIf="isLoadingSaved">
              <td colspan="9" class="text-center text-muted py-3">
                <i class="fas fa-spinner fa-spin me-1"></i> Loading...
              </td>
            </tr>
          
            <!-- Empty -->
            <tr *ngIf="!isLoadingSaved && header && !isEditingHeader && (!savedRows || savedRows.length === 0)">
              <td colspan="9" class="text-center text-muted py-3">
                No data
              </td>
            </tr>
          
            <!-- Rows -->
            <tr *ngFor="let r of savedRows">
              <td>{{ r.itemNo }}</td>
              <td class="fw-600">{{ r.itemName }}</td>
              <td>{{ r.wosNo }}</td>
              <td>{{ r.dwg }}</td>
              <td>{{ r.dieNo }}</td>
              <td>{{ r.lotNo }}</td>
              <td class="text-end fw-600">{{ r.qty }}</td>                          
              <td class="text-center">
                <button
                  class="btn-row edit"
                  (click)="onEditRow(r)"
                  title="Edit"
                >
                  <i class="fas fa-pen"></i>
                </button>
              </td>

              <td class="text-center">
                <button
                  class="btn-row delete"
                  (click)="onDeleteRow(r)"
                  title="Delete"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
          
        </table>
      </div>

    </div>
  </div>
</div>





