<div class="receive-page">
  <div class="receive-card">

    <div class="receive-header">
      <h2 class="receive-title">Receive Part (IQC)</h2>

    </div>
    <div class="instruction-card" *ngIf="isLoadingHeader">
      <div class="instruction-title">
        <i class="fas fa-spinner fa-spin"></i>
        <span>Loading header...</span>
      </div>
    </div>

    <!-- =======================
         Header form (create / edit)
    ======================== -->
    <form class="receive-form" autocomplete="off" *ngIf="showHeaderForm">
      <div class="form-grid">
    
        <!-- วันที่รับ (ซ้าย) -->
        <div class="form-field">
          <label class="form-label">วันที่รับ</label>
          <div class="input-wrap">
            <input
              class="form-control"
              type="datetime-local"
              [(ngModel)]="form.receiveDateByUser"
              name="receiveDateByUser"
            />
            <span class="input-icon"><i class="far fa-calendar"></i></span>
          </div>
        </div>
    
        <!-- Shift (ขวา) -->
        <div class="form-field">
          <label class="form-label">Shift</label>
          <div class="input-wrap">
            <select class="form-control" [(ngModel)]="form.shift" name="shift">
              <option value="" disabled>เลือกกะการทำงาน</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>
    
        <!-- Vendor (เต็มแถว) -->
        <div class="form-field span-2">
          <label class="form-label">Select Vendor</label>
          <div class="input-wrap">
            <select class="form-control" [(ngModel)]="form.venderId" name="venderId">
              <option [ngValue]="null" disabled>เลือก Vendor</option>
              <option *ngFor="let v of vendors" [ngValue]="v.id">{{ v.name }}</option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>
    
        <!-- Item No (ซ้าย) -->
        <div class="form-field">
          <label class="form-label">Select Item No.</label>
          <div class="input-wrap">
            <select class="form-control" [(ngModel)]="form.itemNo" name="itemNo" (ngModelChange)="onSelectItemNo($event)">
              <option value="" disabled>เลือก Item No</option>
              <option *ngFor="let it of items" [value]="it.itemNo">{{ it.itemNo }}</option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>
    
        <!-- Item Name (ขวา) -->
        <div class="form-field">
          <label class="form-label">Auto Item Name</label>
          <div class="input-wrap">
            <input class="form-control" type="text" [(ngModel)]="form.itemName" name="itemName" readonly />
            <span class="input-icon"><i class="fas fa-tag"></i></span>
          </div>
        </div>
    
        <!-- ControlLot (ซ้าย) -->
        <div class="form-field">
          <label class="form-label">Control Lot</label>
          <div class="input-wrap">
            <select class="form-control" [(ngModel)]="form.controlLotId" name="controlLotId">
              <option [ngValue]="null" disabled>เลือก ControlLot</option>
              <option *ngFor="let c of controlLots" [ngValue]="c.id">{{ c.name }}</option>
            </select>
            <span class="input-icon"><i class="fas fa-chevron-down"></i></span>
          </div>
        </div>
    
        <!-- QtyBox (ขวา) -->
        <div class="form-field">
          <label class="form-label">Total QTY BOX</label>
          <input class="form-control" type="number" min="1" [(ngModel)]="form.qtyBox" name="qtyBox" placeholder="Max 42 Box/ครั้ง" />
        </div>
    
      </div>
    
      <button type="button" class="btn-save" (click)="onSaveHeader()" [disabled]="isSavingHeader">
        {{ isSavingHeader ? 'Saving...' : 'Save' }}
      </button>
    </form>
    

    <!-- =======================
         Header summary (saved)
    ======================== -->
   <!-- ===== HEADER SUMMARY (มี header แล้ว และไม่ได้ edit) ===== -->
<!-- ===== HEADER SUMMARY (Receive) ===== -->
<div class="header-summary-wrap" *ngIf="header && !isEditingHeader">

  <div class="header-summary">
    <div class="header-summary-title">
      <span class="hs-icon">
        <i class="fas fa-clipboard-list"></i>
      </span>
      <span>Header Saved</span>
    </div>

    <div class="header-summary-grid">
      <div class="hs-item">
        <div class="hs-k">วันที่รับ</div>
        <div class="hs-v">{{ header.receiveDateByUser | date:'yyyy-MM-dd HH:mm' }}</div>
      </div>

      <div class="hs-item">
        <div class="hs-k">Shift</div>
        <div class="hs-v">{{ header.shift }}</div>
      </div>

      <div class="hs-item span-2">
        <div class="hs-k">Vendor</div>
        <div class="hs-v">{{ vendorName(header.venderId) }}</div>
      </div>

      <div class="hs-item">
        <div class="hs-k">Item No.</div>
        <div class="hs-v">{{ header.itemNo }}</div>
      </div>

      <div class="hs-item">
        <div class="hs-k">Item Name</div>
        <div class="hs-v">{{ header.itemName }}</div>
      </div>

      <div class="hs-item">
        <div class="hs-k">Control Lot</div>
        <div class="hs-v">{{ controlLotName(header.controlLotId) }}</div>
      </div>

      <div class="hs-item">
        <div class="hs-k">Qty Box</div>
        <div class="hs-v">{{ header.qtyBox }}</div>
      </div>
    </div>

    <div class="header-summary-actions">
      <button type="button" class="btn-delete-header" (click)="true">
        <i class="fas fa-trash-alt"></i>
        Delete Header
      </button>
      <button type="button" class="btn-soft" (click)="onClickEditHeader()">
        <i class="fas fa-pen me-1"></i>
        Edit Header
      </button>
    </div>
  </div>

</div>



    <!-- Instruction -->
    <div class="instruction-card">
      <div class="instruction-title">
        <i class="fas fa-qrcode"></i>
        <span>Scan QR Code Instructions</span>
      </div>

      <ul class="instruction-list">
        <li>สแกนได้ทีละ 1 QR ต่อครั้ง</li>
        <li>กด <b>Confirm Lot</b> เพื่อบันทึกลง Temp</li>
        <li>กด <b>Receive</b> เพื่อย้ายไป Table จริง (เดี๋ยวทำต่อขั้นนี้)</li>
      </ul>
    </div>




      <!-- ===== Temp Stack (รอรับข้อมูล / ยังไม่ Confirm) ===== -->
      <div class="box-full-wrap" *ngIf="isBoxFull">
        <div class="box-full-banner">
          <i class="fas fa-check-circle" ></i>
          <span>Box ครบแล้ว</span>
        </div>
      </div>



    <!-- =======================
         Temp Stack
    ======================== -->
    <div class="stack-card" *ngIf="!isBoxFull">
      <div class="stack-header">
        <div class="stack-title">
          <i class="fas fa-qrcode" style="color:#1bdb9e"></i>
          <span>Scan QR Form WOS</span>
        </div>
      </div>

      <div class="stack-grid">
        <div class="stack-item">
          <div class="stack-k">Item No.</div>
          <input #scanItemNo class="form-control" type="text"
          [(ngModel)]="boxForm.itemNo" name="scanItemNo"
          (keydown.enter)="onScanEnter('itemNo', $event)"
          [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox" />
        </div>

        <div class="stack-item">
          <div class="stack-k">Item Name</div>
          <input #scanItemName class="form-control" type="text"
          [(ngModel)]="boxForm.itemName" name="scanItemName"
          (keydown.enter)="onScanEnter('itemName', $event)"
          [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox" />
        
        </div>

        <div class="stack-item">
          <div class="stack-k">Item WOS No.</div>
          <input #scanWosNo class="form-control" type="text"
          [(ngModel)]="boxForm.wosNo" name="scanWosNo"
          (keydown.enter)="onScanEnter('wosNo', $event)"
          [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox" />
        </div>

        <div class="stack-item">
          <div class="stack-k">DWG</div>
          <input #scanDwg class="form-control" type="text"
          [(ngModel)]="boxForm.dwg" name="scanDwg"
          (keydown.enter)="onScanEnter('dwg', $event)"
          [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox" />
        </div>

        <div class="stack-item">
          <div class="stack-k">Die No.</div>
          <input #scanDieNo class="form-control" type="text"
          [(ngModel)]="boxForm.dieNo" name="scanDieNo"
          (keydown.enter)="onScanEnter('dieNo', $event)"
          [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox" />
        </div>

        <div class="stack-item">
          <div class="stack-k">Lot No.</div>
          <input #scanLotNo class="form-control" type="text"
          [(ngModel)]="boxForm.lotNo" name="scanLotNo"
          (keydown.enter)="onScanEnter('lotNo', $event)"
          [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox" />
        </div>

        <div class="stack-item">
          <div class="stack-k">Quantity</div>
          <input
          #scanQty
          class="form-control"
          type="number"
          [(ngModel)]="boxForm.qty"
          name="scanQty"
          (keydown.enter)="onScanEnter('qty', $event)"
          (keydown.tab)="loopFocusToFirst($event)"
          [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox"
          />
        </div>
      </div>

      <div class="stack-actions">
        <!-- <button type="button" class="btn-soft" (click)="onConfirmLot()" [disabled]="!header || isEditingHeader || isBoxFull || isSavingBox">
          <i class="fas fa-check-circle me-1"></i>
          Confirm Lot
        </button> -->
        <button type="button" class="btn-soft danger" (click)="onClearBoxForm()" [disabled]="!header || isEditingHeader || isSavingBox">
          <i class="fas fa-trash-alt me-1"></i>
          Clear
        </button>
      </div>
    </div>

    <!-- =======================
         Saved list (Temp DB)
    ======================== -->
    <div class="saved-card">
      <div class="saved-header">
        <div class="saved-title">
          <i class="fas fa-clipboard-check"></i>
          <span>รายการที่ Scan เข้ามาแล้ว</span>
          <span
          class="ms-2 badge rounded-pill bg-secondary box-badge"
          *ngIf="header && !isEditingHeader"
          title="จำนวนรายการที่บันทึกแล้ว"
        >
          BOX: {{ savedRows.length || 0 }}
        </span>
        
        </div>

        <div class="saved-right">
          <button
          type="button"
          class="btn-soft danger"
          (click)="onDeleteAllBoxScan()"
          [disabled]="!header || isEditingHeader || isLoadingSaved || isClearingAll || (savedRows.length === 0)"
        >
        <i class="fas fa-trash-alt me-1"></i>
          Clear
        </button>
        
          <button type="button" 
          class="btn-receive" 
          (click)="onClickReceive()"
          [disabled]="
          isReceiveing ||
          !header ||
          isEditingHeader ||
          isLoadingSaved ||
          (savedRows.length < header!.qtyBox) ||
          (savedRows.length > header!.qtyBox) 
        "
          
          >
            <i class="fas fa-check-double me-1"></i>
            Receive
          </button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="saved-table">
          <thead>
            <tr>
              <th>Item No.</th>
              <th>Item Name</th>
              <th>WOS NO</th>
              <th>DWG</th>
              <th>DIE NO</th>
              <th>LOT NO</th>
              <th class="text-end">QTY</th>
              <th class="text-center">Edit</th>
              <th class="text-end">Delete</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let r of savedRows">
              <td>{{ r.itemNo }}</td>
              <td class="fw-600">{{ r.itemName }}</td>
              <td>{{ r.wosNo }}</td>
              <td>{{ r.dwg }}</td>
              <td>{{ r.dieNo }}</td>
              <td>{{ r.lotNo }}</td>
              <td class="text-end fw-600">{{ r.qty }}</td>
              <td class="text-center">
                <button
                  class="btn-row edit"
                  (click)="onEditRow(r)"
                  title="Edit"
                >
                  <i class="fas fa-pen"></i>
                </button>
              </td>
              <td class="text-end">
                <button type="button" 
                class="btn-row delete" 
                (click)="onDeleteRow(r)">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>

            <tr *ngIf="!savedRows.length">
              <td colspan="8" style="text-align:center; padding:14px; color:#6b7c93">
                No temp box
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="saved-footnote">
        * ปุ่ม Receive จะย้ายข้อมูลจาก Temp ไป Table จริง และล้าง Temp
      </div>
    </div>

  </div>
</div>
